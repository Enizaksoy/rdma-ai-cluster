# ECN, CNP, and DCQCN - Complete Summary

**Author:** Eniz Aksoy, CCIE #23970
**Date:** January 11, 2026
**Based on:** Lab pcap analysis and technical discussion

---

## Table of Contents

1. [Three-Layer Congestion Control](#three-layer-congestion-control)
2. [ECN (Explicit Congestion Notification)](#ecn-explicit-congestion-notification)
3. [CNP (Congestion Notification Packet)](#cnp-congestion-notification-packet)
4. [DCQCN Algorithm Flow](#dcqcn-algorithm-flow)
5. [Queue Separation - CNP vs RDMA Data](#queue-separation---cnp-vs-rdma-data)
6. [DSCP Marking](#dscp-marking)
7. [PCAP Analysis Results](#pcap-analysis-results)
8. [Configuration Reference](#configuration-reference)

---

## Three-Layer Congestion Control

```
Layer 1: PFC (Priority Flow Control)
├── Link-layer lossless mechanism
├── Pause frames when buffers full
└── Last resort - reactive

Layer 2: ECN (Explicit Congestion Notification)
├── IP-layer congestion signaling
├── Marks packets before queue fills
└── Early warning - proactive

Layer 3: DCQCN (Data Center QCN)
├── Transport-layer rate control
├── CNP processing at sender NIC
└── Dynamic rate adjustment
```

**Goal:** ECN triggers DCQCN rate reduction BEFORE PFC is needed.

---

## ECN (Explicit Congestion Notification)

### ECN Bits in IP Header

| ECN Value | Binary | Name | Meaning |
|-----------|--------|------|---------|
| 0 | 00 | Not-ECT | Not ECN capable |
| 1 | 01 | ECT(1) | ECN capable |
| 2 | 10 | ECT(0) | ECN capable |
| 3 | 11 | CE | **Congestion Experienced** |

### ECN Flow

```
1. Sender marks packet ECT (ECN capable)
   IP Header: ECN = 10 (ECT(0))

2. Switch queue fills, marks CE
   IP Header: ECN = 11 (CE) ◄── Congestion signal

3. Receiver sees CE mark
   Generates CNP packet back to sender

4. Sender receives CNP
   Reduces transmission rate
```

### Switch ECN Marking (Cisco Nexus)

```cisco
policy-map type queuing rdma-egress-queue
  class type queuing c-out-q3
    bandwidth percent 50
    random-detect minimum-threshold 150 kbytes maximum-threshold 1500 kbytes
    ecn    ◄── Enable ECN marking
```

---

## CNP (Congestion Notification Packet)

### What is CNP?

CNP is a **real packet** (not just a header) that flows on the network:
- Generated by **receiver NIC** when it sees ECN CE-marked packets
- Sent **back to sender** as congestion feedback
- Contains **QP number** to identify which flow should slow down

### CNP Packet Structure

```
┌────────────────────────────────────────────┐
│ Ethernet Header                            │
│   Src: Receiver MAC                        │
│   Dst: Sender MAC                          │
├────────────────────────────────────────────┤
│ IP Header                                  │
│   Src: Receiver IP                         │
│   Dst: Sender IP                           │
│   DSCP: 48 (CS6) ◄── HIGH PRIORITY        │
│   ECN: ECT(0)                              │
├────────────────────────────────────────────┤
│ UDP Header                                 │
│   Src Port: 0                              │
│   Dst Port: 4791 (RoCEv2)                  │
├────────────────────────────────────────────┤
│ InfiniBand BTH                             │
│   OpCode: 0x81 (129) ◄── CNP IDENTIFIER   │
│   Dest QP: 0x000d1e ◄── FLOW TO SLOW DOWN │
│   PSN: 0                                   │
└────────────────────────────────────────────┘
```

### Key CNP Fields

| Field | Value | Purpose |
|-------|-------|---------|
| **DSCP** | 48 (CS6) | Ensures CNP gets strict priority |
| **UDP Port** | 4791 | RoCEv2 port |
| **OpCode** | 0x81 (129) | Identifies packet as CNP |
| **Dest QP** | e.g., 0x000d1e | Tells sender which flow to slow down |

---

## DCQCN Algorithm Flow

### Complete Flow Diagram

```
STEP 1: Sender sends RDMA data
┌────────┐                              ┌────────┐
│ Sender │ ──── RDMA Write ────────────►│Receiver│
│  NIC   │     (QP 0x000d1d)            │  NIC   │
└────────┘     DSCP 0/24, ECN=10        └────────┘
                    │
                    ▼
             ┌─────────────┐
             │   Switch    │
             │ Queue fills │
             │ Marks ECN=11│ (CE)
             └─────────────┘

STEP 2: Receiver sees CE, generates CNP
┌────────┐                              ┌────────┐
│ Sender │ ◄──────── CNP ──────────────│Receiver│
│  NIC   │    DSCP 48, OpCode 0x81     │  NIC   │
└────────┘    Dest QP: 0x000d1e        └────────┘

STEP 3: Sender NIC processes CNP
┌─────────────────────────────────────────────┐
│ Sender NIC Rate Limiter                     │
│                                             │
│ CNP received for QP 0x000d1e                │
│ Current rate: 25 Gbps                       │
│ New rate: 12.5 Gbps (DCQCN algorithm)      │
│                                             │
│ Other QPs: unchanged                        │
└─────────────────────────────────────────────┘
```

### Key Points

1. **Rate limiting happens at SENDER NIC**, not at switch
2. **CNP contains QP number** - sender knows exactly which flow to slow
3. **Per-flow rate control** - only affected QP slows down
4. **Hardware-based** - ConnectX NIC does this in firmware

---

## Queue Separation - CNP vs RDMA Data

### Why Different Queues?

```
┌─────────────────────────────────────────────────────────────┐
│                      SWITCH QUEUES                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  qos-group 7 (Strict Priority)     qos-group 3 (Bandwidth)  │
│  ┌─────────────────────┐           ┌─────────────────────┐  │
│  │   CNP Packets       │           │   RDMA Data         │  │
│  │   DSCP 48           │           │   DSCP 0/24         │  │
│  │   ~64 bytes each    │           │   Bulk traffic      │  │
│  │   FIRST OUT         │           │   ECN marked here   │  │
│  └─────────────────────┘           └─────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Queue Assignment

| Traffic | DSCP | Queue | Priority | Reason |
|---------|------|-------|----------|--------|
| **RDMA Data** | 0/24 | qos-group 3 | Normal | Bulk data, can queue |
| **CNP** | 48 | qos-group 7 | **Strict** | Feedback must be instant |

### Why CNP Needs Strict Priority

```
If CNP delayed:
  Sender doesn't know about congestion
  Keeps sending at full rate
  More congestion → More ECN marks
  Buffer fills → PFC activates → Potential drops

With CNP strict priority:
  CNP arrives immediately
  Sender slows down quickly
  Congestion relieved
  No PFC needed
```

---

## DSCP Marking

### Who Marks DSCP?

| Packet Type | Who Marks | How | Default |
|-------------|-----------|-----|---------|
| **RDMA Data** | Source NIC | **Manual config required** | DSCP 0 |
| **CNP** | Source NIC | **Automatic (hardcoded)** | DSCP 48 |

### Why CNP Always Has DSCP 48

```
CNP Generation (NIC firmware):
┌────────────────────────────────────────────┐
│  if (received_packet.ECN == CE) {          │
│      generate_CNP();                       │
│      CNP.DSCP = 48;  ◄── HARDCODED!       │
│      send(CNP);                            │
│  }                                         │
│  // Per RoCEv2/DCQCN specification        │
│  // Cannot change this                     │
└────────────────────────────────────────────┘
```

### Why RDMA Data May Have DSCP 0

```
RDMA Data Generation:
┌────────────────────────────────────────────┐
│  RDMA_Write() {                            │
│      packet.DSCP = configured_tos;         │
│                                            │
│      // If not configured = 0 (default)    │
│  }                                         │
└────────────────────────────────────────────┘
```

### Recommended DSCP Values

| Traffic Type | DSCP | TOS Byte | Binary |
|-------------|------|----------|--------|
| RDMA Data | 24 (CS3) | 0x60 | 011000 |
| CNP | 48 (CS6) | 0xC0 | 110000 |

---

## PCAP Analysis Results

### Capture: rdma_ecn.pcap

**File:** `C:\Users\eniza\Documents\claudechats\ecn_pcaps\rdma_ecn.pcap`

### Statistics

| Metric | Value |
|--------|-------|
| **Total Packets** | 808,992 |
| **Duration** | 4.796 seconds |
| **Total Bytes** | 3.08 GB |
| **Traffic Type** | RoCEv2 (RRoCE) |

### ECN Analysis

| ECN State | Count | Percentage |
|-----------|-------|------------|
| ECT(0) - Normal | 687,671 | 85% |
| CE - Congestion | 121,321 | **15%** |

### DSCP Analysis

| DSCP Value | Count | Traffic Type |
|------------|-------|--------------|
| 0 (Default) | 807,037 | RDMA Data (not marked) |
| 48 (CS6) | 1,955 | **CNP Packets** |

### Key Findings

1. **15% of traffic was ECN CE-marked** (congestion experienced)
2. **1,955 CNP packets** generated in response
3. **CNP to CE ratio: 1:62** - one CNP causes sender to slow for multiple packets
4. **RDMA data not marked** - NICs using default DSCP 0
5. **CNP correctly marked DSCP 48** - automatic by NIC firmware

### Example CNP Packet (Frame 42818)

```
Frame 42818: 74 bytes
├── Ethernet: VMware_af:0d:ec → VMware_af:39:dc
├── IPv4: 192.168.250.114 → 192.168.250.117
│   ├── DSCP: 48 (CS6)
│   └── ECN: ECT(0)
├── UDP: Port 0 → 4791 (RoCEv2)
└── InfiniBand BTH
    ├── OpCode: 129 (0x81) = CNP
    └── Dest QP: 0x000d1e
```

### Traffic Pattern Observed

```
Frames 1-42817:     Normal operation
├── DSCP: 0         (RDMA data)
├── ECN: ECT(0)     (capable, no congestion)
└── No CNP

Frames 42818+:      Congestion detected!
├── ECN: CE (0x03)  (congestion experienced)
├── CNP generated   (DSCP 48, OpCode 0x81)
└── DCQCN active
```

---

## Configuration Reference

### ConnectX NIC - Set DSCP for RDMA Traffic

```bash
# Check current TOS setting
cat /sys/class/infiniband/mlx5_0/tc/1/traffic_class

# Set DSCP 24 for RDMA (TOS = DSCP << 2 = 96)
echo 96 > /sys/kernel/config/rdma_cm/mlx5_0/ports/1/default_roce_tos

# Or via mlxconfig
sudo mlxconfig -d /dev/mst/mt4115_pciconf0 set \
  ROCE_CC_PRIO_MASK_P1=0x08 \
  ROCE_CC_ALGORITHM_P1=DCQCN
```

### Cisco Nexus - QoS for RDMA and CNP

```cisco
! Classify RDMA traffic (DSCP 24)
class-map type qos match-all rdma-traffic
  match dscp 24

! Classify CNP traffic (DSCP 48)
class-map type qos match-all cnp-traffic
  match dscp 48

! Mark traffic to qos-groups
policy-map type qos rdma-marking
  class cnp-traffic
    set qos-group 7
  class rdma-traffic
    set qos-group 3
  class class-default
    set qos-group 0

! Queuing policy
policy-map type queuing rdma-queuing
  class type queuing c-out-q7
    priority level 1           ! Strict priority for CNP
  class type queuing c-out-q3
    bandwidth remaining percent 80
    random-detect ecn          ! ECN marking for RDMA
  class type queuing c-out-q-default
    bandwidth remaining percent 20

! Apply to interfaces
interface Ethernet1/1-8
  service-policy type qos input rdma-marking
  service-policy type queuing output rdma-queuing
```

### Wireshark Filters

```
# Show only CNP packets
ip.dsfield.dscp == 48

# Show ECN Congestion Experienced packets
ip.dsfield.ecn == 3

# Show RoCEv2 traffic
udp.port == 4791

# Show CNP by TOS byte
ip.dsfield == 0xc2
```

---

## Summary Table

| Concept | RDMA Data | CNP |
|---------|-----------|-----|
| **Direction** | Sender → Receiver | Receiver → Sender |
| **Purpose** | Transfer data | Congestion feedback |
| **DSCP** | 0/24 (configurable) | 48 (automatic) |
| **Queue** | qos-group 3 | qos-group 7 (strict) |
| **Generated by** | Application | NIC hardware |
| **Contains** | Payload data | QP number to slow |
| **ECN handling** | Marked by switch | Triggers generation |

---

## Key Takeaways

1. **CNP is a real packet** - not just a header field
2. **CNP carries QP number** - sender knows exactly which flow to slow
3. **DSCP 48 for CNP is automatic** - hardcoded in NIC firmware
4. **DSCP for RDMA data requires configuration** - defaults to 0
5. **Rate limiting happens at sender NIC** - not at switch
6. **Queue separation is critical** - CNP must get strict priority
7. **ECN triggers CNP** - switch marks CE, receiver generates CNP

---

*Document generated from lab analysis and technical discussion on January 11, 2026*
